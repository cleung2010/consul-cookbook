description "Consul Service Discovery Platform"

emits consul-up

start on runlevel [2345]
stop on runlevel [!2345]

script
  [ -e /etc/default/<%= @instance %> ] && . /etc/default/<%= @instance %>

  export GOMAXPROCS=${GOMAXPROCS:-2}
  CMD="<%= Chef::Consul.active_binary(node) %> agent -config-dir <%= @config_dir %>" <%= @extra_options %>
  LOGFILE="/var/log/<%= @instance %>.log"
  exec sudo -u <%= @run_user %> -g <%= @run_group %> $CMD >> "$LOGFILE"
end script

post-start exec initctl emit consul-up

kill signal INT

respawn
respawn limit 10 10
